import nmap
from PyQt5.QtCore import QObject, pyqtSignal

class VulnerabilityScanner(QObject):
    """
    VulnerabilityScanner uses nmap to scan for common vulnerabilities on the devices
    discovered in the network scan.
    """
    finished = pyqtSignal(list)

    def __init__(self):
        super().__init__()
        self.nm = nmap.PortScanner()

    def scan_vulnerabilities(self, hosts):
        """
        Scans the given hosts for vulnerabilities.
        :param hosts: A list of hosts to scan.
        """
        vulnerability_report = []
        for host in hosts:
            self.nm.scan(host['ip'], arguments='-sV --script=vuln')
            for proto in self.nm[host['ip']].all_protocols():
                lport = self.nm[host['ip']][proto].keys()
                for port in lport:
                    port_info = self.nm[host['ip']][proto][port]
                    if 'script' in port_info:
                        vulnerabilities = port_info['script']
                        report_entry = {
                            'ip': host['ip'],
                            'port': port,
                            'vulnerabilities': vulnerabilities
                        }
                        vulnerability_report.append(report_entry)

        self.finished.emit(vulnerability_report)

    def run_scan(self, ip_range):
        """
        Starts the vulnerability scanning process for the specified IP range.
        :param ip_range: IP range or a single IP to scan.
        """
        # Normally, you would integrate the network scanner to get the list of hosts
        # For demonstration, let's assume it's a single host IP
        hosts = [{'ip': ip_range}]
        self.scan_vulnerabilities(hosts)
